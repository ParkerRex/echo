version: '3'

services:
  # Backend service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - GOOGLE_CLOUD_PROJECT=automations-457120
      - TESTING_MODE=true
      - GOOGLE_APPLICATION_CREDENTIALS=/app/@credentials/service_account.json
      - GCS_UPLOAD_BUCKET=automations-youtube-videos-2025
    volumes:
      # Mount the local directory for development
      - ./backend/video_processor:/app/video_processor
      # Mount test data directory
      - ./backend/test_data:/app/test_data
      # Mount credentials file
      - ./@credentials/service_account.json:/app/@credentials/service_account.json:ro
      # Mount Google Cloud credentials if available
      - ${HOME}/.config/gcloud:/root/.config/gcloud:ro
    command: >
      gunicorn --bind :8080 --workers 1 --threads 8 --timeout 0
      --reload video_processor.main:app

  # Frontend service
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules/
    environment:
      - BACKEND_URL=http://backend:8080
    depends_on:
      - backend

  # Mock GCS service for testing (optional, include when needed)
  mock-gcs:
    build:
      context: ./backend
      dockerfile: Dockerfile.mock
    ports:
      - "8081:8081"
    environment:
      - PORT=8081
      - GOOGLE_CLOUD_PROJECT=automations-457120
      - TESTING_MODE=true
      - GOOGLE_APPLICATION_CREDENTIALS=/app/@credentials/service_account.json
      - VIDEO_PROCESSOR_URL=http://backend:8080
    volumes:
      - ./backend/scripts:/app/scripts
      - ./backend/test_data:/app/test_data
      - ./@credentials/service_account.json:/app/@credentials/service_account.json:ro
    depends_on:
      - backend