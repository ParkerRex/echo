version: '3'

services:
  video-processor:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - GOOGLE_CLOUD_PROJECT=automations-457120
      - TESTING_MODE=true
      - GOOGLE_APPLICATION_CREDENTIALS=/app/@credentials/service_account.json
      # Add any other environment variables your app needs
    volumes:
      # Mount the local directory for development
      - ./video_processor:/app/video_processor
      # Mount test data directory
      - ./test_data:/app/test_data
      # Mount credentials file
      - ./@credentials/service_account.json:/app/@credentials/service_account.json:ro
      # Mount Google Cloud credentials if available
      - ${HOME}/.config/gcloud:/root/.config/gcloud:ro
    command: >
      gunicorn --bind :8080 --workers 1 --threads 8 --timeout 0
      --reload video_processor.main:app

  # Mock service for testing
  mock-gcs:
    build:
      context: .
      dockerfile: Dockerfile.mock
    ports:
      - "8081:8081"
    environment:
      - PORT=8081
      - GOOGLE_CLOUD_PROJECT=automations-457120
      - TESTING_MODE=true
      - GOOGLE_APPLICATION_CREDENTIALS=/app/@credentials/service_account.json
    volumes:
      - ./scripts:/app/scripts
      - ./test_data:/app/test_data
      # Mount credentials file
      - ./@credentials/service_account.json:/app/@credentials/service_account.json:ro
    depends_on:
      - video-processor
